@page "/arraydatadrilldown/{Id:int}"

@using MudBlazor
@using Newtonsoft.Json.Linq
@using Plotly.Blazor
@using Plotly.Blazor.Traces
@using Plotly.Blazor.Traces.ScatterLib
@using Plotly.Blazor.LayoutLib

@inject BlazorSingletonService settings
@inject IIndexView indexData
@inject NavigationManager nvm

<h3>Array Data Drilldown</h3>

<br />
<p><strong>Name:</strong> @dataName</p>

@if (tooManyArrays)
{
    <MudAlert Severity="Severity.Warning">
        This view only supports data types with a maximum of two arrays.
    </MudAlert>
}
else if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate />
    <p>Loading...</p>
}
else
{
    <MudTabs Elevation="4" Rounded Centered Color="Color.Primary">

        <MudTabPanel Text="Data Table">
            <MudTable Items="dataArray"
                      Dense
                      Hover
                      Bordered
                      Striped
                      FixedHeader
                      Height="600px"
                      Virtualize>

                <HeaderContent>
                    <MudTh>@header1</MudTh>
                    <MudTh>@header2</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="@header1">@context.Array1</MudTd>
                    <MudTd DataLabel="@header2">@context.Array2</MudTd>
                </RowTemplate>

            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Chart">
            <PlotlyChart @ref="chart"
                         Data="plotData"
                         Layout="layout"
                         Config="config" />
        </MudTabPanel>

    </MudTabs>
}

<br />
<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoToHome">
    Home Page
</MudButton>

@code {

    [Parameter] public int Id { get; set; }

    private bool isLoading = true;
    private bool tooManyArrays;

    private string dataName = string.Empty;
    private string header1 = string.Empty;
    private string header2 = string.Empty;

    private List<DataArray> dataArray = new();

    private PlotlyChart chart;
    private Config config = new();
    private Layout layout = new();
    private IList<ITrace> plotData = new List<ITrace>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            string indexSource = SD.Sqlite
                ? settings.Project
                : settings.TargetConnector;

            var index = await indexData.GetSingleIndexItem(indexSource, Id);
            if (index == null)
                return;

            dataName = index.DataName;

            JObject dataObject = JObject.Parse(index.JsonDataObject);

            var taxonomyList = await indexData.GetIndexTaxonomy(indexSource);
            var taxonomy = taxonomyList.FirstOrDefault(t => t.DataName == index.DataType);

            if (taxonomy == null)
            {
                tooManyArrays = true;
                return;
            }

            var headers = new List<string>();
            foreach (var item in taxonomy.Arrays)
            {
                var attribute = item.Value<string>("Attribute");
                if (!string.IsNullOrWhiteSpace(attribute))
                {
                    headers.Add(attribute);
                }
            }

            if (headers.Count > 2)
            {
                tooManyArrays = true;
                return;
            }

            header1 = headers[0];
            header2 = headers[1];

            double[] array1 = dataObject[header1]?.ToString().ConvertStringToArray() ?? Array.Empty<double>();
            double[] array2 = dataObject[header2]?.ToString().ConvertStringToArray() ?? Array.Empty<double>();

            int len = Math.Min(array1.Length, array2.Length);

            for (int i = 0; i < len; i++)
            {
                dataArray.Add(new DataArray
                {
                    Array1 = array1[i],
                    Array2 = array2[i]
                });
            }

            BuildChart(array1, array2);

            isLoading = false;

            await InvokeAsync(async () =>
            {
                if (chart != null)
                    await chart.React();
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ArrayDataDrilldown error: {ex}");
        }
    }

    private void BuildChart(double[] xValues, double[] yValues)
    {
        var x = xValues.Cast<object>().ToList();
        var y = yValues.Cast<object>().ToList();

        layout = new Layout
        {
            XAxis = new List<XAxis>
            {
                new XAxis
                {
                    Title = new Plotly.Blazor.LayoutLib.XAxisLib.Title
                    {
                        Text = header1
                    }
                }
            },
            YAxis = new List<YAxis>
    {
        new YAxis
        {
            Title = new Plotly.Blazor.LayoutLib.YAxisLib.Title
            {
                Text = header2
            }
        }
    }
        };


        plotData = new List<ITrace>
        {
            new Scatter
            {
                Name = $"{header1} vs {header2}",
                Mode = ModeFlag.Lines | ModeFlag.Markers,
                X = x,
                Y = y
            }
        };
    }

    private void GoToHome()
    {
        nvm.NavigateTo("/");
    }

    private sealed class DataArray
    {
        public double Array1 { get; set; }
        public double Array2 { get; set; }
    }
}
