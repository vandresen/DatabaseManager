@using Plotly.Blazor
@using Plotly.Blazor.LayoutLib
@using Plotly.Blazor.Traces
@using Plotly.Blazor.Traces.ScatterLib

@if (noData)
{
    <br />
    <p>Not enough data points</p>
}
else if (DataType == "WellBore")
{
    <PlotlyChart style="height: 60vh; min-height: 150px"
                 Layout="layout"
                 Config="config"
                 Data="data"
                 Id="MapChart" />
}
else
{
    <br />
    <p>No data available for surface view</p>
}

@code {
    [Parameter] public string DataType { get; set; }
    [Parameter] public List<DmsIndex>? Index { get; set; }

    private bool noData;
    private IList<ITrace> data = new List<ITrace>();

    private readonly Layout layout = new()
    {
        Title = new Title { Text = "2D Plotview" },
        XAxis = new List<XAxis>
        {
            new XAxis
            {
                ShowGrid = false,
                ShowLine = true,
                ShowTickLabels = true,
                LineWidth = 2,
                Mirror = Plotly.Blazor.LayoutLib.XAxisLib.MirrorEnum.True,
                Ticks = Plotly.Blazor.LayoutLib.XAxisLib.TicksEnum.Outside
            }
        },
        YAxis = new List<YAxis>
        {
            new YAxis
            {
                ShowGrid = false,
                ShowLine = true,
                ShowTickLabels = true,
                LineWidth = 2,
                Mirror = Plotly.Blazor.LayoutLib.YAxisLib.MirrorEnum.True,
                Ticks = Plotly.Blazor.LayoutLib.YAxisLib.TicksEnum.Outside
            }
        }
    };

    private readonly Config config = new();

    protected override void OnParametersSet()
    {
        BuildChartData();
    }

    private void BuildChartData()
    {
        data.Clear();
        noData = true;

        if (Index == null || Index.Count == 0)
            return;

        var x = new List<object>();
        var y = new List<object>();

        foreach (var item in Index)
        {
            if (string.IsNullOrWhiteSpace(item.JsonData))
                continue;

            double? lat = item.JsonData.GetNumberFromJson("SURFACE_LATITUDE");
            double? lon = item.JsonData.GetNumberFromJson("SURFACE_LONGITUDE");

            if (lat is null or -99999.0 || lon is null or -99999.0)
                continue;

            x.Add(lon.Value);
            y.Add(lat.Value);
        }

        if (x.Count == 0)
            return;

        noData = false;

        data.Add(new Scatter
        {
            Name = "ScatterTrace",
            Mode = ModeFlag.Markers,
            X = x,
            Y = y
        });
    }
}
